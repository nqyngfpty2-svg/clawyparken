{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
  <h2 class="h5 mb-0">Tag: <span class="mono">{{ day }}</span></h2>
  <div class="d-flex flex-wrap gap-2 align-items-center">
    <a class="btn btn-outline-secondary btn-sm" href="/day/{{ prev_day }}">◀ Vortag</a>
    <a class="btn btn-outline-secondary btn-sm" href="/day/{{ next_day }}">Nächster Tag ▶</a>
    <form class="d-flex gap-2 align-items-center" method="get" action="/day/{{ day }}" onsubmit="event.preventDefault(); const v=this.querySelector('input[name=goto_day]').value; if(v){ window.location='/day/'+v; }">
      <input type="date" name="goto_day" class="form-control form-control-sm" value="{{ day }}" />
      <button class="btn btn-outline-primary btn-sm" type="submit">Gehe zu Tag</button>
    </form>
    <button class="btn btn-brand btn-sm blink-soft" type="button" data-bs-toggle="collapse" data-bs-target="#plan" aria-expanded="false" aria-controls="plan">Parkplatzplan</button>
  </div>
</div>

<div class="collapse mt-3" id="plan">
  <div class="card" style="border: 1px solid rgba(11,107,58,0.25);">
    <div class="card-header" style="background: linear-gradient(90deg, #0B6B3A, #0A5F34); color:#fff;" >
      <div class="d-flex justify-content-between align-items-center">
        <div><strong>Parkplatzplan</strong> <span class="opacity-75 small">(nummeriert)</span></div>
        <a href="/plan/annotated.png" target="_blank" class="text-white small">In neuem Tab öffnen</a>
      </div>
    </div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
        <button class="btn btn-sm btn-outline-primary" type="button" onclick="planZoom(-0.1)">−</button>
        <button class="btn btn-sm btn-outline-primary" type="button" onclick="planZoom(+0.1)">+</button>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="planReset()">Reset</button>
        <span class="text-muted small">Zoom: <span id="planZoomLabel" class="mono">100%</span></span>
      </div>

      <div id="planWrap" style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px; max-height: 70vh; background: #fafafa;">
        <img id="planImg" src="/plan/annotated.png?v={{ day }}" alt="Parkplatzplan" style="transform-origin: 0 0; display:block;" />
      </div>

      <div class="text-muted small mt-2">Tipp: Mit Strg+Mausrad kannst du zusätzlich browserweit zoomen. Hier kannst du aber auch unabhängig rein/raus zoomen.</div>
    </div>
  </div>
</div>

<script>
let _planScale = 0.25;
function _planApply(){
  const img = document.getElementById('planImg');
  if(!img) return;
  img.style.transform = `scale(${_planScale})`;
  const lbl = document.getElementById('planZoomLabel');
  if(lbl) lbl.innerText = Math.round(_planScale*100) + '%';
}
function planZoom(delta){
  _planScale = Math.max(0.1, Math.min(3.0, _planScale + delta));
  _planApply();
}
function planReset(){
  _planScale = 0.25;
  _planApply();
}
window.addEventListener('load', _planApply);
</script>

{% if offers|length == 0 %}
  <div class="alert alert-warning">Für diesen Tag gibt es aktuell keine angebotenen Parkplätze.</div>
{% else %}
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Parkplatz</th>
          <th>Status</th>
          <th style="width: 420px">Buchen</th>
        </tr>
      </thead>
      <tbody>
      {% for o in offers %}
        <tr>
          <td class="mono">{{ o.spot }}</td>
          <td>
            {% if o.booking_status == 'active' %}
              <span class="badge text-bg-secondary">gebucht</span>
            {% else %}
              <span class="badge text-bg-success">frei</span>
            {% endif %}
          </td>
          <td>
            {% if o.booking_status == 'active' %}
              <span class="text-muted">Schon gebucht.</span>
            {% else %}
              <form class="row g-2" method="post" action="/book">
                <input type="hidden" name="day" value="{{ day }}" />
                <input type="hidden" name="spot" value="{{ o.spot }}" />
                <div class="col-sm-8">
                  <span class="text-muted small">Anonym: Nach dem Buchen bekommst du einen Buchungscode.</span>
                </div>
                <div class="col-sm-4">
                  <button class="btn btn-primary btn-sm w-100" type="submit">Buchen</button>
                </div>
              </form>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<div class="mt-3">
  <a class="btn btn-outline-secondary btn-sm" href="/">Heute</a>
</div>
{% endblock %}
